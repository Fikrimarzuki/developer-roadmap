# CONTEXT MANAGER

## With statement
## Apa?
Fitur python yang mengatur proses setup dan teardown secara otomatis

## Contoh
```python
with open("file.txt") as f:
  data = f.read()
```
Alasan
- file akan ditutup otomatis
- aman dari error
- tidak perlu try/finally manual
- lebih rapi dan pythonic

## Tanpa context manager
```python
f = open("file.txt")
data = f.read()
f.close()
```
Jika error terjadi sebelum close(), file tidak akan ditutup menyebabkan
- memory leak
- lock file
- corrupted resource

## Dengan context manager
```python
with open("file.txt") as f:
  data = f.read()
```
saat keluar dari blok with:
- file ditutup otomatis
- resource dibersihkan
- tetap aman meskipun terjadi exception


## Bagaimana with bekerja
- Python memanggil 2 method khusus (dunder)
  - __enter__()
  - __exit__()
```python
class Example:
  def __enter__(self):
    print("Entered")
    return self
  
  def __exit__(self, exc_type, exc_value, traceback):
    print("Exited")
```
Pemakaian
```python
with Example() as e:
  print("Inside")
```


## Membuat context manager sendiri
### Contoh timer
```python
import time

class Timer:
  def __enter__(self):
    self.start = time.time()
    return self
  
  def __exit__(self, exc_type, exc, tb):
    self.end = time.time()
    print(f"Time: {self.end - self.start:.4f}s")
```
Pemakaian
```python
with Timer():
  for _ in range(1_000_000):
    pass
```
Sangat berguna untuk bencmarking


## Context manager dengan contextlib
Membuat context manager dengan generator
```python
from contextlib import contextmanager

@contextmanager
def open_file(name):
  f = open(name)
  try:
    yield f
  finally:
    f.close()
```
Pemakaian
```python
with open_file("file.txt") as f:
  print(f.read())
```
Lebih simple lebih bersih


## Use case di dunia nyata
- File handling
- Database connection
  Contoh tanpa context
  ```python
  conn = db.connect()
  try:
    result = conn.execute(...)
  finally:
    conn.close()
  ```
  Dengan context
  ```python
  with db.connect() as conn:
    conn.execute(...)
  ```
- Locking (threading)
  ```python
  from threading import Lock

  lock = Lock()

  with lock:
    # critical section
    counter += 1
  ```
- Resouce cleanup di FastAPI / Flask
  FastAPI dependency
  ```python
  from contextlib import asynccontextmanager

  @asynccontextmanager
  async def lifespan(app):
    print("Starting app...")
    yield
    print("Shutting down...")
  ```
- Temporary directory / files
  ```python
  from tempfile import TemporaryDirectory

  with TemporaryDirectory() as tmpdir:
    print("Using temp folder:", tmpdir)
  ```
- Redirect stdout (testing)
  ```python
  from contextlib import redirect_stdout
  import io

  f = io.StringIO()
  with redirect_stdout(f):
    print("Hello")

  print(f.getvalue())  # "Hello\n"
  ```
- Timing, profiling, logging
  Timer
  ```python
  with Timer():
    heavy_function()
  ```
  Logger
  ```python
  with log_section("loading data"):
    load_data()
  ```


## Handling exceptions inside context manager
Contoh context manager yang men-suppress exception
```python
class IgnoreErrors:
  def __enter__(self):
    pass
  def __exit__(self, exc_type, exc, tb):
    return True  # ignore error
```
Pemakaian
```python
with IgnoreErrors():
  1 / 0

print("Still running")
```
Useful untuk test/debug


## __exit__ parameters explained
__exit__(self, exc_type, exc_value, traceback)
Jika:
- tidak ada error - semuanya None
- ada error - param berisi info error

Jika __exit__ return True, error disuppress
Jika return False (default), error tetap dilempar

